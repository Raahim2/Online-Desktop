<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Breathing Exercises</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic style for the breathing animation element */
        .breathing-visualizer > * {
            transition: all 0.5s ease-in-out; /* Default transition, JS will override duration */
        }
        /* Hide elements managed by Alpine until it's ready */
        [x-cloak] { display: none !important; }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="font-sans transition-colors duration-300" x-data="breathingApp()" :class="themeClasses.body" @keydown.space.prevent="togglePlayPause" @keydown.esc.prevent="stopExercise">

    <!-- Main Container -->
    <div class="min-h-screen flex flex-col items-center justify-center p-4 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold" :class="themeClasses.headerPrimary">Personalized Breathing</h1>
            <p class="text-lg mt-2" :class="themeClasses.headerSecondary">Find your calm, one breath at a time.</p>
        </header>

        <!-- Main Content Area (Visualizer + Controls) -->
        <main class="w-full max-w-5xl flex flex-col lg:flex-row items-stretch justify-center gap-6 lg:gap-8">

            <!-- Visualizer Section -->
            <section class="w-full lg:w-1/2 flex flex-col items-center justify-center p-6 rounded-lg shadow-xl min-h-[400px] relative order-1 lg:order-2" :class="themeClasses.cardBg">
                <!-- Initial Message -->
                <div x-show="!isRunning && !isPaused" class="text-center" :class="themeClasses.textMuted">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" :class="themeClasses.iconColor" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M12 6v6l4 2" />
                     </svg>
                     <p class="text-lg">Configure your session and press Start.</p>
                </div>

                <!-- Visualizer Area -->
                <div x-show="isRunning || isPaused" class="relative w-60 h-60 sm:w-72 sm:h-72 flex items-center justify-center mb-4 breathing-visualizer" x-cloak>
                    <!-- Circle Visualizer -->
                    <div x-show="settings.visualization === 'circle'" class="absolute w-16 h-16 rounded-full"
                         :class="themeClasses.visualizerAccent"
                         :style="`transform: scale(${visualState.scale}); opacity: ${visualState.opacity}; transition: transform ${currentTransitionDuration}s cubic-bezier(0.4, 0, 0.2, 1), opacity ${currentTransitionDuration * 0.8}s ease-in-out;`"></div>

                    <!-- Bar Visualizer -->
                     <div x-show="settings.visualization === 'bar'" class="w-full h-10 rounded-full overflow-hidden" :class="themeClasses.visualizerTrack">
                        <div class="h-full rounded-full" :class="themeClasses.visualizerAccent"
                             :style="`width: ${visualState.progress}%; transition: width ${currentTransitionDuration}s cubic-bezier(0.4, 0, 0.2, 1);`"></div>
                    </div>

                     <!-- Text Visualizer (Only shows phase text) -->
                     <div x-show="settings.visualization === 'text'" class="text-center">
                         <!-- Phase text below handles this -->
                     </div>

                    <!-- Breath Phase Text -->
                    <span class="absolute text-2xl font-semibold z-10 select-none" :class="themeClasses.visualizerText" x-text="breathPhase"></span>
                </div>

                 <!-- Timer Display -->
                <div x-show="isRunning || isPaused" class="text-center mb-4" x-cloak>
                    <p class="text-xl font-medium" :class="themeClasses.textPrimary">
                        <span x-text="formatTime(timer)"></span> / <span x-text="formatTime(totalDuration)"></span>
                    </p>
                </div>

                 <!-- Progress Bar -->
                 <div x-show="isRunning || isPaused" class="w-full max-w-sm h-2 rounded-full overflow-hidden" :class="themeClasses.progressTrack" x-cloak>
                    <div class="h-full rounded-full transition-all duration-1000 ease-linear" :class="themeClasses.progressFill" :style="`width: ${progressPercentage}%`"></div>
                 </div>

                 <!-- Start/Pause/Resume/Stop Controls -->
                 <div class="flex items-center space-x-4 mt-6">
                     <button @click="startExercise" x-show="!isRunning && !isPaused" class="px-8 py-3 text-lg font-semibold rounded-md text-white transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent" :class="themeClasses.buttonPrimary" title="Start (Spacebar)">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                         Start
                    </button>
                     <button @click="pauseExercise" x-show="isRunning && !isPaused" class="px-8 py-3 text-lg font-semibold rounded-md text-white transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent" :class="themeClasses.buttonWarning" title="Pause (Spacebar)">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                         Pause
                    </button>
                     <button @click="resumeExercise" x-show="isPaused" class="px-8 py-3 text-lg font-semibold rounded-md text-white transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent" :class="themeClasses.buttonSuccess" title="Resume (Spacebar)">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>
                         Resume
                    </button>
                     <button @click="stopExercise" x-show="isRunning || isPaused" class="p-3 rounded-md text-white transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-transparent" :class="themeClasses.buttonDanger" title="Stop (Esc)">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /> </svg>
                     </button>
                 </div>
            </section>

            <!-- Settings/Controls Section -->
            <section class="w-full lg:w-1/2 p-6 rounded-lg shadow-xl order-2 lg:order-1" :class="themeClasses.cardBg">
                <h2 class="text-2xl font-semibold mb-6 pb-3 border-b" :class="[themeClasses.textPrimary, themeClasses.border]">Settings</h2>

                <!-- Session Duration -->
                <div class="mb-6">
                    <label for="session-duration" class="block text-sm font-medium mb-1" :class="themeClasses.label">Session Duration</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="session-duration-slider" x-model.number="settings.sessionDurationMinutes" min="1" max="60" step="1" class="w-full h-2 rounded-lg appearance-none cursor-pointer accent-indigo-600" :class="themeClasses.range" :disabled="isRunning || isPaused">
                        <input type="number" id="session-duration-input" x-model.number="settings.sessionDurationMinutes" min="1" max="60" class="w-20 p-2 border rounded-md text-center" :class="themeClasses.input" :disabled="isRunning || isPaused">
                        <span class="text-sm" :class="themeClasses.textMuted">min</span>
                    </div>
                </div>

                <!-- Breath Cycle -->
                <div class="mb-6">
                     <label class="block text-sm font-medium mb-2" :class="themeClasses.label">Breath Cycle (seconds)</label>
                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div>
                            <label for="inhale-duration" class="block text-xs font-medium mb-1" :class="themeClasses.labelMuted">Inhale</label>
                            <input type="number" id="inhale-duration" x-model.number="settings.inhale" min="1" max="20" step="0.1" class="w-full p-2 border rounded-md text-center" :class="themeClasses.input" :disabled="isRunning || isPaused">
                        </div>
                         <div>
                            <label for="hold-in-duration" class="block text-xs font-medium mb-1" :class="themeClasses.labelMuted">Hold</label>
                            <input type="number" id="hold-in-duration" x-model.number="settings.holdIn" min="0" max="20" step="0.1" class="w-full p-2 border rounded-md text-center" :class="themeClasses.input" :disabled="isRunning || isPaused">
                        </div>
                        <div>
                            <label for="exhale-duration" class="block text-xs font-medium mb-1" :class="themeClasses.labelMuted">Exhale</label>
                            <input type="number" id="exhale-duration" x-model.number="settings.exhale" min="1" max="20" step="0.1" class="w-full p-2 border rounded-md text-center" :class="themeClasses.input" :disabled="isRunning || isPaused">
                        </div>
                         <div>
                            <label for="hold-out-duration" class="block text-xs font-medium mb-1" :class="themeClasses.labelMuted">Hold</label>
                            <input type="number" id="hold-out-duration" x-model.number="settings.holdOut" min="0" max="20" step="0.1" class="w-full p-2 border rounded-md text-center" :class="themeClasses.input" :disabled="isRunning || isPaused">
                        </div>
                    </div>
                    <p class="text-xs mt-2" :class="themeClasses.textMuted">Total cycle: <span x-text="totalCycleTime.toFixed(1)"></span>s</p>
                </div>


                <!-- Visualization Style -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2" :class="themeClasses.label">Visualization Style</label>
                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="visualization" value="circle" x-model="settings.visualization" class="form-radio" :class="themeClasses.radio" :disabled="isRunning || isPaused">
                            <span class="ml-2" :class="themeClasses.textSecondary">Circle</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="visualization" value="bar" x-model="settings.visualization" class="form-radio" :class="themeClasses.radio" :disabled="isRunning || isPaused">
                            <span class="ml-2" :class="themeClasses.textSecondary">Bar</span>
                        </label>
                         <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="visualization" value="text" x-model="settings.visualization" class="form-radio" :class="themeClasses.radio" :disabled="isRunning || isPaused">
                            <span class="ml-2" :class="themeClasses.textSecondary">Text Only</span>
                        </label>
                    </div>
                </div>

                 <!-- Background Sounds -->
                 <div class="mb-6">
                     <label for="background-sound" class="block text-sm font-medium mb-1" :class="themeClasses.label">Background Sound</label>
                     <select id="background-sound" x-model="settings.sound" @change="changeSound($event.target.value)" class="w-full p-2 border rounded-md" :class="themeClasses.select" :disabled="isRunning || isPaused">
                         <option value="none">None</option>
                         <option value="rain">Light Rain</option>
                         <option value="waves">Ocean Waves</option>
                         <option value="forest">Forest Ambience</option>
                         <option value="music">Calm Music</option>
                     </select>
                     <!-- Audio elements - kept outside visible DOM but accessible via JS -->
                     <audio id="audio-rain" src="https://cdn.pixabay.com/download/audio/2022/08/10/audio_db3ff16d10.mp3?filename=light-rain-ambient-114354.mp3" preload="none" loop></audio>
                     <audio id="audio-waves" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_79e3c6f705.mp3?filename=waves-and- seagulls-nature-sounds-loopable-1-minute-107481.mp3" preload="none" loop></audio>
                     <audio id="audio-forest" src="https://cdn.pixabay.com/download/audio/2022/09/24/audio_960a61361e.mp3?filename=forest_ambience-6225.mp3" preload="none" loop></audio>
                     <audio id="audio-music" src="https://cdn.pixabay.com/download/audio/2022/11/17/audio_70c3b7c6e3.mp3?filename=inspiring-cinematic-ambient-116199.mp3" preload="none" loop></audio>

                     <!-- Volume Control -->
                     <div x-show="settings.sound !== 'none'" class="mt-3" x-cloak>
                         <label for="volume" class="block text-xs font-medium mb-1" :class="themeClasses.labelMuted">Volume</label>
                         <input type="range" id="volume" min="0" max="1" step="0.01" x-model="settings.volume" @input="setVolume($event.target.value)" class="w-full h-2 rounded-lg appearance-none cursor-pointer accent-indigo-600" :class="themeClasses.range">
                     </div>
                 </div>

                 <!-- Color Themes -->
                 <div>
                     <label class="block text-sm font-medium mb-2" :class="themeClasses.label">Color Theme</label>
                     <div class="flex flex-wrap gap-2">
                         <button @click="setTheme('light')" class="w-8 h-8 rounded-full bg-gray-100 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2" :class="settings.theme === 'light' ? 'ring-2 ring-offset-2 ring-indigo-500' : 'hover:ring-1 hover:ring-gray-400'" title="Light"></button>
                         <button @click="setTheme('dark')" class="w-8 h-8 rounded-full bg-gray-800 border-2 border-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2" :class="settings.theme === 'dark' ? 'ring-2 ring-offset-2 ring-indigo-400' : 'hover:ring-1 hover:ring-gray-500'" title="Dark"></button>
                         <button @click="setTheme('nature')" class="w-8 h-8 rounded-full bg-emerald-100 border-2 border-emerald-300 focus:outline-none focus:ring-2 focus:ring-offset-2" :class="settings.theme === 'nature' ? 'ring-2 ring-offset-2 ring-emerald-500' : 'hover:ring-1 hover:ring-emerald-400'" title="Nature"></button>
                         <button @click="setTheme('ocean')" class="w-8 h-8 rounded-full bg-sky-100 border-2 border-sky-300 focus:outline-none focus:ring-2 focus:ring-offset-2" :class="settings.theme === 'ocean' ? 'ring-2 ring-offset-2 ring-sky-500' : 'hover:ring-1 hover:ring-sky-400'" title="Ocean"></button>
                     </div>
                 </div>

            </section>
        </main>

        <!-- Footer -->
        <footer class="mt-10 lg:mt-12 text-center text-sm" :class="themeClasses.textMuted">
            <p>&copy; <span x-text="new Date().getFullYear()"></span> Personalized Breathing. Relax and Recharge.</p>
             <p class="mt-1">Use <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-300 rounded-md" :class="themeClasses.kbd">Spacebar</kbd> to Play/Pause, <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-300 rounded-md" :class="themeClasses.kbd">Esc</kbd> to Stop.</p>
        </footer>

    </div>

    <!-- Alpine.js Component Logic -->
    <script>
        const themes = {
            light: {
                body: 'bg-gray-100',
                cardBg: 'bg-white',
                headerPrimary: 'text-indigo-600',
                headerSecondary: 'text-gray-600',
                textPrimary: 'text-gray-800',
                textSecondary: 'text-gray-700',
                textMuted: 'text-gray-500',
                label: 'text-gray-700',
                labelMuted: 'text-gray-500',
                input: 'bg-white border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500',
                select: 'bg-white border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500',
                radio: 'form-radio text-indigo-600 focus:ring-indigo-500',
                range: 'bg-gray-200 accent-indigo-600',
                border: 'border-gray-200',
                iconColor: 'text-indigo-400',
                visualizerAccent: 'bg-indigo-500',
                visualizerTrack: 'bg-indigo-100',
                visualizerText: 'text-indigo-700',
                progressTrack: 'bg-gray-200',
                progressFill: 'bg-gradient-to-r from-indigo-400 to-purple-500',
                buttonPrimary: 'bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500',
                buttonWarning: 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400',
                buttonSuccess: 'bg-green-500 hover:bg-green-600 focus:ring-green-400',
                buttonDanger: 'bg-red-500 hover:bg-red-600 focus:ring-red-400',
                kbd: 'text-gray-800 bg-gray-100 border-gray-300'
            },
            dark: {
                body: 'bg-gray-900',
                cardBg: 'bg-gray-800',
                headerPrimary: 'text-indigo-400',
                headerSecondary: 'text-gray-400',
                textPrimary: 'text-gray-100',
                textSecondary: 'text-gray-300',
                textMuted: 'text-gray-500',
                label: 'text-gray-300',
                labelMuted: 'text-gray-500',
                input: 'bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500',
                select: 'bg-gray-700 border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500',
                radio: 'form-radio text-indigo-400 bg-gray-600 border-gray-500 focus:ring-indigo-400 focus:ring-offset-gray-800',
                range: 'bg-gray-700 accent-indigo-500',
                border: 'border-gray-700',
                iconColor: 'text-indigo-500',
                visualizerAccent: 'bg-indigo-500',
                visualizerTrack: 'bg-gray-700',
                visualizerText: 'text-indigo-300',
                progressTrack: 'bg-gray-700',
                progressFill: 'bg-gradient-to-r from-indigo-500 to-purple-600',
                buttonPrimary: 'bg-indigo-600 hover:bg-indigo-500 focus:ring-indigo-400',
                buttonWarning: 'bg-yellow-600 hover:bg-yellow-500 focus:ring-yellow-400',
                buttonSuccess: 'bg-green-600 hover:bg-green-500 focus:ring-green-400',
                buttonDanger: 'bg-red-600 hover:bg-red-500 focus:ring-red-400',
                kbd: 'text-gray-300 bg-gray-700 border-gray-600'
            },
            nature: {
                body: 'bg-emerald-50',
                cardBg: 'bg-emerald-100',
                headerPrimary: 'text-emerald-700',
                headerSecondary: 'text-emerald-600',
                textPrimary: 'text-emerald-900',
                textSecondary: 'text-emerald-800',
                textMuted: 'text-emerald-600',
                label: 'text-emerald-700',
                labelMuted: 'text-emerald-600',
                input: 'bg-white border-emerald-300 text-emerald-900 focus:ring-emerald-500 focus:border-emerald-500',
                select: 'bg-white border-emerald-300 text-emerald-900 focus:ring-emerald-500 focus:border-emerald-500',
                radio: 'form-radio text-emerald-600 focus:ring-emerald-500 focus:ring-offset-emerald-100',
                range: 'bg-emerald-200 accent-emerald-600',
                border: 'border-emerald-200',
                iconColor: 'text-emerald-500',
                visualizerAccent: 'bg-emerald-500',
                visualizerTrack: 'bg-emerald-200',
                visualizerText: 'text-emerald-700',
                progressTrack: 'bg-emerald-200',
                progressFill: 'bg-gradient-to-r from-emerald-400 to-green-500',
                buttonPrimary: 'bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500',
                buttonWarning: 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-400', // Keep yellow distinct
                buttonSuccess: 'bg-lime-600 hover:bg-lime-700 focus:ring-lime-500',
                buttonDanger: 'bg-rose-500 hover:bg-rose-600 focus:ring-rose-400',
                kbd: 'text-emerald-800 bg-emerald-100 border-emerald-300'
            },
            ocean: {
                body: 'bg-sky-50',
                cardBg: 'bg-sky-100',
                headerPrimary: 'text-sky-700',
                headerSecondary: 'text-sky-600',
                textPrimary: 'text-sky-900',
                textSecondary: 'text-sky-800',
                textMuted: 'text-sky-600',
                label: 'text-sky-700',
                labelMuted: 'text-sky-600',
                input: 'bg-white border-sky-300 text-sky-900 focus:ring-sky-500 focus:border-sky-500',
                select: 'bg-white border-sky-300 text-sky-900 focus:ring-sky-500 focus:border-sky-500',
                radio: 'form-radio text-sky-600 focus:ring-sky-500 focus:ring-offset-sky-100',
                range: 'bg-sky-200 accent-sky-600',
                border: 'border-sky-200',
                iconColor: 'text-sky-500',
                visualizerAccent: 'bg-sky-500',
                visualizerTrack: 'bg-sky-200',
                visualizerText: 'text-sky-700',
                progressTrack: 'bg-sky-200',
                progressFill: 'bg-gradient-to-r from-sky-400 to-blue-500',
                buttonPrimary: 'bg-sky-600 hover:bg-sky-700 focus:ring-sky-500',
                buttonWarning: 'bg-amber-500 hover:bg-amber-600 focus:ring-amber-400',
                buttonSuccess: 'bg-teal-500 hover:bg-teal-600 focus:ring-teal-400',
                buttonDanger: 'bg-orange-500 hover:bg-orange-600 focus:ring-orange-400',
                kbd: 'text-sky-800 bg-sky-100 border-sky-300'
            },
        };

        function breathingApp() {
            return {
                // Settings
                settings: {
                    sessionDurationMinutes: 5,
                    inhale: 4.0,
                    holdIn: 2.0,
                    exhale: 6.0,
                    holdOut: 1.0,
                    visualization: 'circle', // 'circle', 'bar', 'text'
                    sound: 'none',
                    volume: 0.5,
                    theme: 'light', // 'light', 'dark', 'nature', 'ocean'
                },
                // State
                isRunning: false,
                isPaused: false,
                timer: 0, // in seconds
                totalDuration: 0, // in seconds
                breathPhase: 'Ready?', // 'Inhale', 'Hold', 'Exhale', 'Hold', 'Get Ready...', 'Paused', 'Complete!'
                visualState: { scale: 1, opacity: 0.6, progress: 0 },
                currentTransitionDuration: 1, // For animation timing sync
                progressPercentage: 0,
                // Intervals/Timeouts
                timerInterval: null,
                breathTimeout: null,
                // Audio
                currentAudio: null,
                audioContext: null, // For smoother playback start/stop potentially
                themeClasses: themes.light, // Default theme classes

                // Computed
                get totalCycleTime() {
                    return parseFloat(this.settings.inhale) + parseFloat(this.settings.holdIn) + parseFloat(this.settings.exhale) + parseFloat(this.settings.holdOut);
                },

                init() {
                    console.log('Breathing App Initializing...');
                    // Load settings from localStorage
                    const savedSettings = localStorage.getItem('breathingAppSettings');
                    if (savedSettings) {
                        try {
                            const parsed = JSON.parse(savedSettings);
                            // Merge saved settings with defaults, ensuring numeric types
                            this.settings = {
                                ...this.settings, // Start with defaults
                                ...parsed,        // Override with saved
                                // Ensure numeric types after loading from JSON
                                sessionDurationMinutes: Number(parsed.sessionDurationMinutes) || 5,
                                inhale: Number(parsed.inhale) || 4.0,
                                holdIn: Number(parsed.holdIn) || 2.0,
                                exhale: Number(parsed.exhale) || 6.0,
                                holdOut: Number(parsed.holdOut) || 1.0,
                                volume: Number(parsed.volume) || 0.5,
                            };
                            console.log('Loaded settings:', this.settings);
                        } catch (e) {
                            console.error("Failed to parse saved settings:", e);
                            localStorage.removeItem('breathingAppSettings'); // Clear corrupted settings
                        }
                    }

                    // Apply initial theme
                    this.applyTheme(this.settings.theme);

                    // Set initial timer display
                    this.updateTotalDuration();
                    this.timer = this.totalDuration;

                    // Set initial audio volume for all audio elements
                    this.$nextTick(() => {
                        this.setVolume(this.settings.volume, true); // Apply to all initially
                    });

                     // Watch for settings changes to save them and update state
                    this.$watch('settings', (newSettings, oldSettings) => {
                         // Deep compare specific numeric values before saving to avoid unnecessary saves/updates
                         const relevantChanges = (
                            newSettings.sessionDurationMinutes !== oldSettings.sessionDurationMinutes ||
                            newSettings.inhale !== oldSettings.inhale ||
                            newSettings.holdIn !== oldSettings.holdIn ||
                            newSettings.exhale !== oldSettings.exhale ||
                            newSettings.holdOut !== oldSettings.holdOut ||
                            newSettings.visualization !== oldSettings.visualization ||
                            newSettings.sound !== oldSettings.sound ||
                            newSettings.volume !== oldSettings.volume ||
                            newSettings.theme !== oldSettings.theme
                         );

                         if (relevantChanges) {
                            console.log('Settings changed, saving:', newSettings);
                            localStorage.setItem('breathingAppSettings', JSON.stringify(newSettings));

                            if (!this.isRunning && !this.isPaused) {
                                this.updateTotalDuration();
                                this.timer = this.totalDuration;
                                this.resetVisuals(); // Reset visuals if settings change while stopped
                            }
                            if (newSettings.theme !== oldSettings.theme) {
                                this.applyTheme(newSettings.theme);
                            }
                            if (newSettings.volume !== oldSettings.volume) {
                                this.setVolume(newSettings.volume); // Update current audio volume
                            }
                            if (newSettings.sound !== oldSettings.sound) {
                                // Sound change handled by @change event on select
                            }
                         }
                    }, { deep: true }); // Use deep watch as settings is an object
                },

                updateTotalDuration() {
                    this.totalDuration = Math.max(1, this.settings.sessionDurationMinutes) * 60; // Ensure minimum 1 minute (60s)
                },

                // --- Core Exercise Logic ---
                startExercise() {
                    if (this.isRunning) return;
                    console.log('Starting exercise...');
                    this.isRunning = true;
                    this.isPaused = false;
                    this.updateTotalDuration(); // Recalculate in case settings changed
                    this.timer = this.totalDuration;
                    this.progressPercentage = 0;
                    this.resetVisuals(); // Ensure visuals start from base state
                    this.startTimer();
                    this.playSound();
                    this.breathPhase = 'Get Ready...';
                    clearTimeout(this.breathTimeout); // Clear any lingering timeouts
                    this.breathTimeout = setTimeout(() => {
                        if (this.isRunning) this.runBreathPhase('inhale');
                    }, 1500); // Short delay before first inhale
                },

                pauseExercise() {
                    if (!this.isRunning || this.isPaused) return;
                    console.log('Pausing exercise...');
                    this.isPaused = true;
                    this.isRunning = false; // Set isRunning false when paused
                    clearInterval(this.timerInterval);
                    clearTimeout(this.breathTimeout);
                    this.pauseSound();
                    this.breathPhase = 'Paused';
                    // Freeze visual state by setting transition duration to 0
                    this.currentTransitionDuration = 0;
                },

                resumeExercise() {
                    if (!this.isPaused) return;
                    console.log('Resuming exercise...');
                    this.isPaused = false;
                    this.isRunning = true;
                    this.startTimer(); // Resume timer interval
                    this.playSound(); // Resume sound
                    // Resume breathing cycle from the phase it was paused in
                    // For simplicity, we restart the cycle or the last known phase logic
                    this.runBreathPhase(this.determineNextPhase()); // Restart cycle for now
                },

                stopExercise() {
                    console.log('Stopping exercise...');
                    const wasRunningOrPaused = this.isRunning || this.isPaused;
                    this.isRunning = false;
                    this.isPaused = false;
                    clearInterval(this.timerInterval);
                    clearTimeout(this.breathTimeout);
                    this.updateTotalDuration(); // Ensure total duration is current
                    this.timer = this.totalDuration; // Reset timer display
                    this.progressPercentage = 0;
                    this.breathPhase = 'Ready?';
                    this.resetVisuals();
                    this.stopSound();
                    if (wasRunningOrPaused) {
                         this.breathPhase = 'Stopped'; // Indicate it was actively stopped
                         setTimeout(() => { if (!this.isRunning && !this.isPaused) this.breathPhase = 'Ready?'; }, 2000); // Reset message after a bit
                    }
                },

                togglePlayPause() {
                    if (this.isRunning) {
                        this.pauseExercise();
                    } else if (this.isPaused) {
                        this.resumeExercise();
                    } else {
                        this.startExercise();
                    }
                },

                // --- Timer & Progress ---
                startTimer() {
                    clearInterval(this.timerInterval); // Clear existing interval
                    this.timerInterval = setInterval(() => {
                        if (!this.isRunning) { // Should not run if paused or stopped
                            clearInterval(this.timerInterval);
                            return;
                        }
                        if (this.timer > 0) {
                            this.timer--;
                            this.progressPercentage = Math.min(100, ((this.totalDuration - this.timer) / this.totalDuration) * 100);
                        } else {
                            this.completeExercise();
                        }
                    }, 1000);
                },

                completeExercise() {
                    console.log('Exercise complete!');
                    this.isRunning = false;
                    this.isPaused = false;
                    clearInterval(this.timerInterval);
                    clearTimeout(this.breathTimeout);
                    this.timer = 0;
                    this.progressPercentage = 100;
                    this.breathPhase = 'Complete!';
                    this.resetVisuals(); // Or show a final state
                    this.stopSound(); // Stop sound on completion
                    // Maybe play a gentle completion chime here
                },

                // --- Breathing Cycle & Visuals ---
                runBreathPhase(phase) {
                    if (!this.isRunning) return; // Stop if exercise was stopped/paused

                    let duration = 0;
                    let nextPhase = '';

                    // Ensure durations are numbers and non-negative
                    const inhaleTime = Math.max(0.1, parseFloat(this.settings.inhale));
                    const holdInTime = Math.max(0, parseFloat(this.settings.holdIn));
                    const exhaleTime = Math.max(0.1, parseFloat(this.settings.exhale));
                    const holdOutTime = Math.max(0, parseFloat(this.settings.holdOut));

                    switch (phase) {
                        case 'inhale':
                            this.breathPhase = 'Inhale';
                            duration = inhaleTime;
                            this.currentTransitionDuration = duration;
                            this.visualState = { scale: 2.5, opacity: 1, progress: 100 };
                            nextPhase = holdInTime > 0 ? 'holdIn' : 'exhale';
                            break;
                        case 'holdIn':
                            this.breathPhase = 'Hold';
                            duration = holdInTime;
                            this.currentTransitionDuration = 0.1; // Quick transition for hold state (no visual change)
                            this.visualState = { scale: 2.5, opacity: 1, progress: 100 }; // Maintain end state of inhale
                            nextPhase = 'exhale';
                            break;
                        case 'exhale':
                            this.breathPhase = 'Exhale';
                            duration = exhaleTime;
                            this.currentTransitionDuration = duration;
                            this.visualState = { scale: 1, opacity: 0.6, progress: 0 };
                            nextPhase = holdOutTime > 0 ? 'holdOut' : 'inhale';
                            break;
                        case 'holdOut':
                            this.breathPhase = 'Hold';
                            duration = holdOutTime;
                            this.currentTransitionDuration = 0.1; // Quick transition for hold state
                            this.visualState = { scale: 1, opacity: 0.6, progress: 0 }; // Maintain end state of exhale
                            nextPhase = 'inhale';
                            break;
                        default: // Should not happen, but reset if it does
                            console.warn("Unknown breath phase:", phase);
                            nextPhase = 'inhale';
                            duration = 1; // Default duration to avoid infinite loop
                    }

                    clearTimeout(this.breathTimeout); // Clear previous timeout
                    this.breathTimeout = setTimeout(() => {
                        this.runBreathPhase(nextPhase);
                    }, duration * 1000);
                },

                 determineNextPhase() {
                    // Simple restart logic for resume
                    return 'inhale';
                },

                resetVisuals() {
                    this.currentTransitionDuration = 0.5; // Reset transition speed
                    this.visualState = { scale: 1, opacity: 0.6, progress: 0 };
                },

                formatTime(totalSeconds) {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                },

                // --- Audio ---
                changeSound(soundValue) {
                    console.log('Changing sound to:', soundValue);
                    this.stopSound(); // Stop previous sound first
                    this.settings.sound = soundValue; // Update setting state
                    if (soundValue !== 'none') {
                        const audioId = `audio-${soundValue}`;
                        // Use $refs if available (more Alpine-idiomatic), else fallback to getElementById
                        const audioElement = this.$refs && this.$refs[audioId] ? this.$refs[audioId] : document.getElementById(audioId);

                        if (audioElement) {
                            this.currentAudio = audioElement;
                            this.currentAudio.volume = this.settings.volume; // Ensure volume is set
                            if (this.isRunning) { // Play only if session is active and running
                                this.playSound();
                            }
                         } else {
                             console.error("Audio element not found for ID:", audioId);
                             this.currentAudio = null;
                         }
                    } else {
                        this.currentAudio = null;
                    }
                },

                playSound() {
                    if (this.currentAudio && this.currentAudio.paused && this.settings.sound !== 'none') {
                        // Attempt to resume audio context if needed (for browser autoplay policies)
                        if (this.audioContext && this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        this.currentAudio.play().catch(e => console.error("Audio play failed:", e));
                        console.log('Playing sound:', this.settings.sound);
                    }
                },

                pauseSound() {
                    if (this.currentAudio && !this.currentAudio.paused) {
                        this.currentAudio.pause();
                        console.log('Pausing sound');
                    }
                },

                stopSound() {
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                        this.currentAudio.currentTime = 0; // Reset playback position
                        console.log('Stopping sound');
                    }
                     // Ensure no other sounds are accidentally playing
                     document.querySelectorAll('audio').forEach(audio => {
                         if (audio !== this.currentAudio && !audio.paused) {
                            audio.pause();
                            audio.currentTime = 0;
                         }
                     });
                     this.currentAudio = null; // Clear current audio reference on stop
                     // Re-select based on settings if needed, handled by changeSound or startExercise
                },

                setVolume(volume, applyToAll = false) {
                     const newVolume = Math.max(0, Math.min(1, parseFloat(volume))); // Clamp volume 0-1
                     this.settings.volume = newVolume; // Update setting state

                     if (this.currentAudio) {
                        this.currentAudio.volume = newVolume;
                     }
                     // Optionally update all audio elements' volume immediately
                     if (applyToAll) {
                         document.querySelectorAll('audio').forEach(audio => {
                             audio.volume = newVolume;
                         });
                     }
                     console.log('Volume set to:', newVolume);
                },

                // --- Theme ---
                setTheme(themeName) {
                    if (this.settings.theme !== themeName) {
                        console.log('Setting theme to:', themeName);
                        this.settings.theme = themeName;
                        // Saving is handled by the $watch('settings', ...)
                        // Applying theme is also handled by the watcher now
                    }
                },

                applyTheme(themeName) {
                    console.log('Applying theme:', themeName);
                    if (themes[themeName]) {
                        this.themeClasses = themes[themeName];
                        // Force Alpine to re-evaluate bindings dependent on themeClasses
                        // This might not be strictly necessary if bindings are direct, but can help
                        this.$dispatch('theme-changed');
                    } else {
                        console.warn("Unknown theme:", themeName, "Falling back to light.");
                        this.themeClasses = themes.light;
                    }
                }
            }
        }
    </script>

</body>
</html>